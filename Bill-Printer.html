<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bill Printer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* ===== Token App Styles ===== */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #fdf6f0 0%, #f8e8f0 100%);
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      padding: 25px;
      position: relative;
      overflow: hidden;
    }
    
    h1 {
      color: #ff4081;
      font-size: 28px;
      margin-bottom: 25px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    
    .form-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .section-title {
      width: 100%;
      text-align: center;
      color: #ff4081;
      font-weight: bold;
      margin: 15px 0 5px;
      font-size: 18px;
    }
    
    select, input {
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s;
      width: 200px;
      box-sizing: border-box;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #ff4081;
      box-shadow: 0 0 0 3px rgba(255, 64, 129, 0.2);
    }
    
    input {
      text-align: center;
    }
    
    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    button {
      background: #ff4081;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s;
      min-width: 150px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .print-btn {
      background: #1a8917;
    }
    
    .print-btn:hover {
      background: #157213;
    }
    
    .save-btn {
      background: #3498db;
    }
    
    .save-btn:hover {
      background: #2980b9;
    }
    
    .history-btn {
      background: #9b59b6;
    }
    
    .history-btn:hover {
      background: #8e44ad;
    }
    
    .disk-btn {
      background: #e67e22;
    }
    
    .disk-btn:hover {
      background: #d35400;
    }
    
    #total-display {
      font-size: 22px;
      color: #1a8917;
      margin: 20px 0;
      font-weight: bold;
    }

    /* Receipt preview styling */
    .receipt-preview {
      margin-top: 25px;
      color: #333;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
      display: none;
      box-sizing: border-box;
    }
    
    .receipt-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 14px;
    }
    
    .receipt-table th {
      background-color: #ff4081;
      color: white;
      padding: 8px 4px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }
    
    .receipt-table td {
      padding: 8px 4px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }
    
    .total-row {
      font-weight: bold;
      background-color: #f9f9f9;
    }
    
    .receipt-header {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ff4081;
    }
    
    .receipt-footer {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 2px solid #ff4081;
      font-size: 14px;
    }

    /* Print-specific styling - CORRECTED */
    @media print {
      body, html {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        height: 100% !important;
        width: 100% !important;
      }
      
      body * {
        visibility: hidden;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
      }
      
      #print-section, 
      #print-section * {
        visibility: visible !important;
      }
      
      #print-section {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 15px !important;
        background: white !important;
        font-size: 14px !important;
        font-family: Arial, sans-serif !important;
        display: block !important;
        height: auto !important;
        overflow: visible !important;
      }
      
      .no-print {
        display: none !important;
      }
      
      .receipt-table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin: 10px 0 !important;
        font-size: 14px !important;
      }
      
      .receipt-table th {
        background-color: #f0f0f0 !important;
        color: black !important;
        padding: 8px 5px !important;
        border: 1px solid #000 !important;
        text-align: center !important;
        font-weight: bold !important;
      }
      
      .receipt-table td {
        padding: 8px 5px !important;
        border: 1px solid #000 !important;
        text-align: center !important;
      }
      
      .receipt-header {
        border-bottom: 2px solid #000 !important;
        margin-bottom: 15px !important;
        padding-bottom: 10px !important;
      }
      
      .receipt-footer {
        border-top: 2px solid #000 !important;
        margin-top: 15px !important;
        padding-top: 10px !important;
      }
      
      /* Ensure all text is black for printing */
      * {
        color: black !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }

    /* Mobile styles */
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      select, input, button {
        padding: 10px 15px;
        font-size: 14px;
        width: 100%;
        max-width: 200px;
      }
      
      .form-section {
        gap: 10px;
      }
      
      .receipt-table {
        font-size: 12px;
      }
      
      .receipt-table th, 
      .receipt-table td {
        padding: 6px 2px;
        font-size: 12px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
    }

    /* Rotating Circle */
    .circle-container {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 40px;
      height: 40px;
      overflow: visible;
      z-index: 1000;
    }

    .circle {
      font-weight: 800;
      color: red;
      text-align: center;
      font-size: 8px;
      background-color: white;
      width: 100%;
      height: 100%;
      border: 3px solid #3498db;
      border-radius: 50%;
      position: relative;
      animation: rotateBorder 5s linear infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }

    .ball {
      position: absolute;
      width: 4px;
      height: 4px;
      background-color: #e74c3c;
      border-radius: 50%;
      top: 0;
      left: 50%;
      margin-top: -2px;
      margin-left: -2px;
      animation: rotateBall 5s linear infinite;
    }

    @keyframes rotateBorder {
      to { transform: rotate(360deg); }
    }

    @keyframes rotateBall {
      to { transform: rotate(360deg); }
    }
    
    /* Print instructions */
    .print-instructions {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 20px 0;
      text-align: left;
      display: none;
    }
    
    .print-instructions h3 {
      color: #1a8917;
      margin-top: 0;
    }
    
    /* Storage info */
    .storage-info {
      background: #e8f4fd;
      border: 1px solid #b6d7f7;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 14px;
      display: none;
    }
    
    /* History Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      overflow: auto;
    }
    
    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #777;
      min-width: auto;
      padding: 0 10px;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    .history-table th {
      background: #f1f1f1;
      padding: 10px;
      text-align: left;
      border-bottom: 2px solid #ddd;
    }
    
    .history-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .action-cell {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 5px 10px;
      font-size: 12px;
      min-width: auto;
    }
    
    /* Hamburger Menu */
    .hamburger-menu {
      position: absolute;
      top: 25px;
      right: 15px;
      z-index: 1000;
    }
    
    .hamburger-icon {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 21px;
      cursor: pointer;
    }
    
    .hamburger-icon span {
      height: 3px;
      width: 100%;
      background-color: #ff4081;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .hamburger-menu.active .hamburger-icon span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .hamburger-menu.active .hamburger-icon span:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger-menu.active .hamburger-icon span:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -6px);
    }
    
    .menu-content {
      position: absolute;
      top: 40px;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      width: 200px;
      padding: 15px;
      display: none;
      text-align: right;
    }
    
    .hamburger-menu.active .menu-content {
      display: block;
    }
    
    .menu-section {
      margin-bottom: 20px;
    }
    
    .menu-section h3 {
      color: #ff4081;
      margin-top: 0;
      font-size: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    
    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .menu-buttons button {
      min-width: auto;
      width: 100%;
      font-size: 14px;
      padding: 10px;
    }
    
    /* Barcode Scanner */
    .barcode-section {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 15px;
      margin: 15px 0;
      text-align: left;
    }
    
    .barcode-section h3 {
      color: #856404;
      margin-top: 0;
    }
    
    #barcode-scanner {
      width: 100%;
      max-width: 500px;
      margin: 10px auto;
      display: none;
    }
    
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    
    #scanner-view {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .scanner-frame {
      width: 70%;
      height: 30%;
      border: 3px solid #ff4081;
      border-radius: 10px;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);
    }
    
    .barcode-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }
    
    .barcode-option {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    
    .barcode-manual-input {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      width: 100%;
    }
    
    .barcode-manual-input input {
      width: 100%;
      max-width: 250px;
    }
    
    .barcode-manual-input button {
      width: 100%;
      max-width: 250px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Rotating Circle -->
    <div class="circle-container">
      <div class="circle">
        ÿßŸÑÿ¨ÿØ€åÿØ
        <br> ÿ®€å⁄©ÿ±ÿ≤
        <div class="ball"></div>
      </div>
    </div>

    <!-- Hamburger Menu -->
    <div class="hamburger-menu" id="hamburger-menu">
      <div class="hamburger-icon" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <h3>üíæ Save Receipts</h3>
          <div class="menu-buttons">
            <button class="disk-btn" onclick="downloadAllReceiptsPDF()">üìÑ Download All as PDF</button>
            <button class="disk-btn" onclick="downloadAllReceiptsJSON()">üìä Download All as JSON</button>
            <button class="disk-btn" onclick="downloadAllReceiptsCSV()">üìã Download All as CSV</button>
            <button class="disk-btn" onclick="exportAllReceipts()">üíæ Export All Data</button>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>‚òÅÔ∏è Cloud Options</h3>
          <div class="menu-buttons">
            <button class="disk-btn" onclick="saveToGoogleDrive()">üì§ Save to Google Drive</button>
            <button class="disk-btn" onclick="emailReceipts()">üìß Email Receipts</button>
            <button class="disk-btn" onclick="printForPhysicalCopy()">üñ®Ô∏è Print for Physical Copy</button>
          </div>
        </div>
        
        <div class="menu-section">
          <h3>üìã History</h3>
          <div class="menu-buttons">
            <button class="history-btn" onclick="showHistory()">üìã View History</button>
          </div>
        </div>
      </div>
    </div></br></br>

    <h1>ÿßŸÑÿ¨ÿØ€åÿØ ÿ≥Ÿà€åŸπÿ≥ ÿß€åŸÜ⁄à ÿ®€å⁄©ÿ±ÿ≤</h1>

    <!-- Barcode Scanner Section -->
    <div class="barcode-section">
      <div class="barcode-options">
        <div class="barcode-option">
          <button class="save-btn" onclick="scanByDevice()" id="device-scanner-btn">üì∑ Scan by Device</button>
        </div>
        
        <div class="barcode-option">
          <button class="save-btn" onclick="toggleScanner()" id="scanner-toggle-btn">üì∑ Scan by Camera</button>
          <button class="save-btn" onclick="stopScanner()" id="scanner-stop-btn" style="display: none;">‚ùå Stop Camera Scanner</button>
          <div id="scanner-container" style="display: none;">
            <div id="barcode-scanner"></div>
            <div class="scanner-overlay">
              <div class="scanner-frame"></div>
            </div>
          </div>
        </div>
        
        <div class="barcode-option">
          <div class="barcode-manual-input">
            <input type="text" id="manual-barcode" placeholder="Enter barcode manually">
            <button class="save-btn" onclick="processManualBarcode()">Add Item</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Print Instructions -->
    <div class="print-instructions" id="print-instructions">
      <h3>üñ®Ô∏è Printing Instructions:</h3>
      <p><strong>To Print:</strong> Click "Print Receipt" ‚Üí Choose your printer ‚Üí Click Print</p>
      <p><strong>To Save as PDF:</strong> Click "Print Receipt" ‚Üí Choose "Save as PDF" ‚Üí Click Save</p>
      <p><strong>Common PDF options:</strong> Microsoft Print to PDF (Windows) or Save as PDF (Mac)</p>
    </div>

    <!-- Storage Info -->
    <div class="storage-info" id="storage-info">
      <strong>‚úì Receipt Saved!</strong> This receipt has been stored in your browser's local storage.
    </div>

    <!-- Order Form -->
    <div class="form-section">
      <div class="section-title">Ice Cream Selection üç¶</div>
      <select id="icecream-choice" onchange="calculateTotal()">
        <option value="">Select Ice Cream</option>
        <option value="IceCream 2 Scoop" data-price="150">Ice Cream 2-Scoop = Rs.150</option>
        <option value="IceCream 3 Scoop" data-price="220">Ice Cream 3-Scoop = Rs.220</option>
        <option value="IceCream 4 Scoop" data-price="300">Ice Cream 4-Scoop = Rs.300</option>
      </select>
      <input type="number" id="icecream-qty" placeholder="Qty" min="1" oninput="calculateTotal()">
    </div>

    <div class="form-section">
      <div class="section-title">Sweet Selection üç∞</div>
      <select id="sweet-choice" onchange="calculateTotal()">
        <option value="">Select Sweet</option>
        <option value="Barfi" data-price="1000">Barfi = Rs.1000/kg</option>
        <option value="Gulab Jamun" data-price="900">Gulab Jamun = Rs.900/kg</option>
        <option value="Rasgulla" data-price="800">Rasgulla = Rs.800/kg</option>
      </select>
      <input type="number" id="sweet-qty" placeholder="Qty (kg)" min="1" oninput="calculateTotal()">
    </div>

    <div id="total-display">Total Amount: Rs. 0</div>

    <div class="button-group">
      <button onclick="generateToken()">üñ®Ô∏è Generate Token</button>
      <button id="print-btn" class="print-btn" onclick="printReceipt()" style="display: none;">üñ®Ô∏è Print Receipt</button>
      <button id="save-btn" class="save-btn" onclick="saveReceipt()" style="display: none;">üíæ Save Receipt</button>
    </div>

    <!-- Receipt Preview -->
    <div class="receipt-preview" id="receipt-preview">
      <div class="receipt-header">
        <h2>ÿßŸÑÿ¨ÿØ€åÿØ ÿ≥Ÿà€åŸπÿ≥ ÿß€åŸÜ⁄à ÿ®€å⁄©ÿ±ÿ≤</h2>
        <p>Token Number: <span id="preview-token-number">--</span></p>
        <p>Date: <span id="preview-date">--</span></p>
      </div>
      
      <table class="receipt-table">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Each Item Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="preview-receipt-items"></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3" style="text-align: right;">Total Amount:</td>
            <td id="preview-receipt-total">Rs. 0</td>
          </tr>
        </tfoot>
      </table>
      
      <div class="receipt-footer">
        <p>Thank you! Visit again.</p>
        <p>€ÅŸàŸÖ ⁄à€åŸÑŸàÿ±€å ⁄©€åŸÑ€ì ÿØÿ±ÿ¨ ÿ∞€åŸÑ ŸÜŸÖÿ®ÿ± Ÿæÿ± ÿ±ÿßÿ®ÿ∑€Å ⁄©ÿ±€å⁄∫: 03007680770</p>
      </div>
    </div>

    <!-- Hidden printable section -->
    <div id="print-section" style="display: none; background: white; padding: 20px;"></div>
  </div>

  <!-- History Modal -->
  <div id="history-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Receipt History</h2>
        <button class="close-modal" onclick="closeHistory()">&times;</button>
      </div>
      <div id="history-content">
        <!-- History content will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    let currentTokenData = null;
    let html5QrcodeScanner = null;
    let isScannerActive = false;
    let deviceScannerActive = false;

    // Barcode to product mapping
    const barcodeMap = {
      '1234567890123': { name: 'IceCream 2 Scoop', price: 150, type: 'icecream' },
      '1234567890124': { name: 'IceCream 3 Scoop', price: 220, type: 'icecream' },
      '1234567890125': { name: 'IceCream 4 Scoop', price: 300, type: 'icecream' },
      '1234567890126': { name: 'Barfi', price: 1000, type: 'sweet' },
      '1234567890127': { name: 'Gulab Jamun', price: 900, type: 'sweet' },
      '1234567890128': { name: 'Rasgulla', price: 800, type: 'sweet' }
    };

    function toggleMenu() {
      document.getElementById('hamburger-menu').classList.toggle('active');
    }

    function scanByDevice() {
      if (deviceScannerActive) {
        deviceScannerActive = false;
        document.getElementById('device-scanner-btn').textContent = 'üì∑ Scan by Device';
        alert("Device scanner deactivated");
        return;
      }
      
      deviceScannerActive = true;
      document.getElementById('device-scanner-btn').textContent = '‚ùå Stop Device Scanner';
      alert("Device scanner activated. Focus is on the barcode input field. Scan your items now.");
      
      // Focus on the manual barcode input
      document.getElementById('manual-barcode').focus();
    }

    function toggleScanner() {
      if (isScannerActive) {
        stopScanner();
        return;
      }
      
      const scannerContainer = document.getElementById('scanner-container');
      const scannerToggleBtn = document.getElementById('scanner-toggle-btn');
      const scannerStopBtn = document.getElementById('scanner-stop-btn');
      
      scannerContainer.style.display = 'block';
      scannerToggleBtn.style.display = 'none';
      scannerStopBtn.style.display = 'block';
      
      // Initialize the barcode scanner
      html5QrcodeScanner = new Html5Qrcode("barcode-scanner");
      
      const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 150 },
        supportedScanTypes: [
          Html5QrcodeScanType.SCAN_TYPE_CAMERA
        ],
        formatsToSupport: [
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.CODE_128
        ]
      };
      
      html5QrcodeScanner.start(
        { facingMode: "environment" }, 
        config,
        onScanSuccess,
        onScanFailure
      ).then(() => {
        isScannerActive = true;
      }).catch(err => {
        console.error("Scanner start failed:", err);
        alert("Failed to start scanner. Please check camera permissions.");
        stopScanner();
      });
    }

    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
          isScannerActive = false;
          document.getElementById('scanner-container').style.display = 'none';
          document.getElementById('scanner-toggle-btn').style.display = 'block';
          document.getElementById('scanner-stop-btn').style.display = 'none';
          html5QrcodeScanner.clear();
        }).catch(err => {
          console.error("Scanner stop failed:", err);
        });
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      // Process the barcode
      processBarcode(decodedText);
    }

    function onScanFailure(error) {
      // Expected to be called often, no need to handle every failure
    }

    function processBarcode(barcode) {
      const product = barcodeMap[barcode];
      
      if (product) {
        // Add the product to the form
        if (product.type === 'icecream') {
          document.getElementById('icecream-choice').value = product.name;
          const currentQty = parseFloat(document.getElementById('icecream-qty').value) || 0;
          document.getElementById('icecream-qty').value = currentQty + 1;
        } else if (product.type === 'sweet') {
          document.getElementById('sweet-choice').value = product.name;
          const currentQty = parseFloat(document.getElementById('sweet-qty').value) || 0;
          document.getElementById('sweet-qty').value = currentQty + 1;
        }
        
        // Update the total
        calculateTotal();
        
        // Show success message
        alert(`Added ${product.name} to your order!`);
      } else {
        alert(`Product with barcode ${barcode} not found in our database.`);
      }
    }

    function processManualBarcode() {
      const barcodeInput = document.getElementById('manual-barcode');
      const barcode = barcodeInput.value.trim();
      
      if (barcode) {
        processBarcode(barcode);
        barcodeInput.value = '';
        
        // If device scanner is active, keep focus on input
        if (deviceScannerActive) {
          setTimeout(() => {
            barcodeInput.focus();
          }, 100);
        }
      } else {
        alert('Please enter a barcode.');
      }
    }

    function calculateTotal() {
      const iceSelect = document.getElementById("icecream-choice");
      const sweetSelect = document.getElementById("sweet-choice");
      const iceQty = parseFloat(document.getElementById("icecream-qty").value) || 0;
      const sweetQty = parseFloat(document.getElementById("sweet-qty").value) || 0;

      const icePrice = iceSelect.options[iceSelect.selectedIndex]?.dataset.price ? 
                      parseFloat(iceSelect.options[iceSelect.selectedIndex].dataset.price) : 0;
      const sweetPrice = sweetSelect.options[sweetSelect.selectedIndex]?.dataset.price ? 
                        parseFloat(sweetSelect.options[sweetSelect.selectedIndex].dataset.price) : 0;

      const total = (icePrice * iceQty) + (sweetPrice * sweetQty);
      document.getElementById("total-display").innerText = `Total Amount: Rs. ${total}`;
    }

    function generateToken() {
      const iceSelect = document.getElementById("icecream-choice");
      const sweetSelect = document.getElementById("sweet-choice");
      const iceChoice = iceSelect.value;
      const sweetChoice = sweetSelect.value;
      const iceQty = parseFloat(document.getElementById("icecream-qty").value) || 0;
      const sweetQty = parseFloat(document.getElementById("sweet-qty").value) || 0;

      if (!iceChoice && !sweetChoice) {
        alert("‚ö†Ô∏è Please select at least one item.");
        return;
      }
      if ((iceChoice && iceQty <= 0) || (sweetChoice && sweetQty <= 0)) {
        alert("‚ö†Ô∏è Please enter valid quantity.");
        return;
      }

      let orders = [];
      if (iceChoice && iceQty > 0) orders.push({ choice: iceChoice, quantity: iceQty });
      if (sweetChoice && sweetQty > 0) orders.push({ choice: sweetChoice, quantity: sweetQty });

      const tokenNumber = Math.floor(Math.random() * 1000);
      
      currentTokenData = {
        token: tokenNumber,
        orders: orders.map(o => ({
          choice: o.choice,
          quantity: o.quantity,
          price_each: o.choice.includes("IceCream") ? 
                      (o.choice.includes("2") ? 150 : o.choice.includes("3") ? 220 : 300) :
                      (o.choice.includes("Barfi") ? 1000 : o.choice.includes("Gulab") ? 900 : 800),
          total_price: o.quantity * (o.choice.includes("IceCream") ? 
                        (o.choice.includes("2") ? 150 : o.choice.includes("3") ? 220 : 300) :
                        (o.choice.includes("Barfi") ? 1000 : o.choice.includes("Gulab") ? 900 : 800))
        })),
        timestamp: new Date().toISOString(),
        total: 0
      };

      let total = 0;
      let previewReceiptItemsHTML = '';

      currentTokenData.orders.forEach((item) => {
        previewReceiptItemsHTML += `
          <tr>
            <td>${item.choice}</td>
            <td>Rs. ${item.price_each}</td>
            <td>${item.quantity}</td>
            <td>Rs. ${item.total_price}</td>
          </tr>
        `;
        total += item.total_price;
      });

      currentTokenData.total = total;

      // Update preview
      document.getElementById("preview-token-number").textContent = tokenNumber;
      document.getElementById("preview-receipt-items").innerHTML = previewReceiptItemsHTML;
      document.getElementById("preview-receipt-total").textContent = `Rs. ${total}`;
      
      const now = new Date();
      const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
      document.getElementById("preview-date").textContent = dateStr;
      
      document.getElementById("total-display").innerText = `Total Payable Amount: Rs. ${total}`;

      // Show elements
      document.getElementById("receipt-preview").style.display = "block";
      document.getElementById("print-btn").style.display = "block";
      document.getElementById("save-btn").style.display = "block";
      document.getElementById("print-instructions").style.display = "block";
      
      document.getElementById("receipt-preview").scrollIntoView({ behavior: 'smooth' });
    }

    function printReceipt() {
      if (!currentTokenData) return;

      let total = 0;
      let printReceiptItemsHTML = '';

      currentTokenData.orders.forEach((item) => {
        printReceiptItemsHTML += `
          <tr>
            <td>${item.choice}</td>
            <td>Rs. ${item.price_each}</td>
            <td>${item.quantity}</td>
            <td>Rs. ${item.total_price}</td>
          </tr>
        `;
        total += item.total_price;
      });

      const now = new Date();
      const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

      const printableContent = `
        <div class="receipt-header">
          <h2>ÿßŸÑÿ¨ÿØ€åÿØ ÿ≥Ÿà€åŸπÿ≥ ÿß€åŸÜ⁄à ÿ®€å⁄©ÿ±ÿ≤</h2>
          <p><strong>Token Number:</strong> ${currentTokenData.token}</p>
          <p><strong>Date:</strong> ${dateStr}</p>
        </div>
        
        <table class="receipt-table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Each Item Price</th>
              <th>Quantity</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            ${printReceiptItemsHTML}
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;"><strong>Total Amount:</strong></td>
              <td><strong>Rs. ${total}</strong></td>
            </tr>
          </tfoot>
        </table>
        
        <div class="receipt-footer">
          <p><strong>Thank you! Visit again.</strong></p>
          <p>€ÅŸàŸÖ ⁄à€åŸÑŸàÿ±€å ⁄©€åŸÑ€ì ÿØÿ±ÿ¨ ÿ∞€åŸÑ ŸÜŸÖÿ®ÿ± Ÿæÿ± ÿ±ÿßÿ®ÿ∑€Å ⁄©ÿ±€å⁄∫: 03007680770</p>
        </div>
      `;

      // Clear and show printable section
      const printSection = document.getElementById("print-section");
      printSection.innerHTML = printableContent;
      printSection.style.display = "block";

      // Wait a moment for DOM to update then print
      setTimeout(() => {
        window.print();
        
        // Reset after printing with a delay
        setTimeout(() => {
          printSection.style.display = "none";
          // Auto-save after printing
          saveReceipt();
          newOrder();
        }, 500);
      }, 300);
    }

    function saveReceipt() {
      if (!currentTokenData) return;
      
      // Get existing receipts from localStorage
      let receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      
      // Add current receipt
      receipts.push({
        ...currentTokenData,
        savedAt: new Date().toISOString()
      });
      
      // Save back to localStorage
      localStorage.setItem('sweetShopReceipts', JSON.stringify(receipts));
      
      // Show confirmation
      document.getElementById("storage-info").style.display = "block";
      setTimeout(() => {
        document.getElementById("storage-info").style.display = "none";
      }, 3000);
      
      console.log('Receipt saved to localStorage. Total receipts:', receipts.length);
    }

    function showHistory() {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      
      if (receipts.length === 0) {
        document.getElementById('history-content').innerHTML = '<p>No receipts found in history.</p>';
      } else {
        let historyHTML = `
          <p><strong>Total Receipts: ${receipts.length}</strong></p>
          <table class="history-table">
            <thead>
              <tr>
                <th>Token #</th>
                <th>Date</th>
                <th>Items</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        receipts.reverse().forEach((receipt, index) => {
          const date = new Date(receipt.timestamp).toLocaleString();
          const items = receipt.orders.map(o => `${o.choice} (${o.quantity})`).join(', ');
          
          historyHTML += `
            <tr>
              <td>${receipt.token}</td>
              <td>${date}</td>
              <td>${items}</td>
              <td>Rs. ${receipt.total}</td>
              <td class="action-cell">
                <button class="action-btn" onclick="reprintReceipt(${receipts.length - 1 - index})">üñ®Ô∏è Print</button>
                <button class="action-btn" onclick="downloadReceiptPDF(${receipts.length - 1 - index})">üìÑ PDF</button>
                <button class="action-btn" onclick="deleteReceipt(${receipts.length - 1 - index})" style="background: #e74c3c;">üóëÔ∏è Delete</button>
              </td>
            </tr>
          `;
        });
        
        historyHTML += `
            </tbody>
          </table>
          <div style="margin-top: 15px;">
            <button onclick="exportAllReceipts()" class="save-btn">üì§ Export All as JSON</button>
            <button onclick="downloadAllReceiptsPDF()" class="save-btn">üìÑ Export All as PDF</button>
            <button onclick="clearAllHistory()" class="action-btn" style="background: #e74c3c;">üóëÔ∏è Clear All History</button>
          </div>
        `;
        
        document.getElementById('history-content').innerHTML = historyHTML;
      }
      
      document.getElementById('history-modal').style.display = 'block';
      toggleMenu(); // Close hamburger menu
    }

    function closeHistory() {
      document.getElementById('history-modal').style.display = 'none';
    }

    function reprintReceipt(index) {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      if (receipts[index]) {
        currentTokenData = receipts[index];
        printReceipt();
      }
      closeHistory();
    }

    function downloadReceiptPDF(index) {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      const receipt = receipts[index];
      
      if (!receipt) return;
      
      // Create PDF
      const doc = new jsPDF();
      
      // Add content to PDF
      doc.setFontSize(20);
      doc.text('ÿßŸÑÿ¨ÿØ€åÿØ ÿ≥Ÿà€åŸπÿ≥ ÿß€åŸÜ⁄à ÿ®€å⁄©ÿ±ÿ≤', 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.text(`Token Number: ${receipt.token}`, 20, 30);
      doc.text(`Date: ${new Date(receipt.timestamp).toLocaleString()}`, 20, 40);
      
      // Add table headers
      doc.text('Item Name', 20, 60);
      doc.text('Price', 80, 60);
      doc.text('Qty', 120, 60);
      doc.text('Subtotal', 150, 60);
      
      let yPos = 70;
      receipt.orders.forEach(order => {
        doc.text(order.choice, 20, yPos);
        doc.text(`Rs. ${order.price_each}`, 80, yPos);
        doc.text(order.quantity.toString(), 120, yPos);
        doc.text(`Rs. ${order.total_price}`, 150, yPos);
        yPos += 10;
      });
      
      // Add total
      doc.setFontSize(14);
      doc.text(`Total Amount: Rs. ${receipt.total}`, 20, yPos + 10);
      
      // Add footer
      doc.setFontSize(10);
      doc.text('Thank you! Visit again.', 20, yPos + 25);
      doc.text('€ÅŸàŸÖ ⁄à€åŸÑŸàÿ±€å ⁄©€åŸÑ€ì ÿØÿ±ÿ¨ ÿ∞€åŸÑ ŸÜŸÖÿ®ÿ± Ÿæÿ± ÿ±ÿßÿ®ÿ∑€Å ⁄©ÿ±€å⁄∫: 03007680770', 20, yPos + 32);
      
      // Save PDF
      doc.save(`receipt-${receipt.token}.pdf`);
    }

    function downloadAllReceiptsPDF() {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      
      if (receipts.length === 0) {
        alert('No receipts to download.');
        return;
      }
      
      // Create a zip file with all PDFs (simulated by downloading individual files)
      receipts.forEach((receipt, index) => {
        setTimeout(() => {
          downloadReceiptPDF(index);
        }, index * 500);
      });
      
      alert(`Downloading ${receipts.length} receipts as PDF files. They will save to your Downloads folder.`);
      toggleMenu(); // Close hamburger menu
    }

    function downloadAllReceiptsJSON() {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      
      if (receipts.length === 0) {
        alert('No receipts to download.');
        return;
      }
      
      const dataStr = JSON.stringify(receipts, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = 'sweet-shop-all-receipts.json';
      link.click();
      
      alert('All receipts downloaded as JSON file. Save this file to your SSD for permanent storage.');
      toggleMenu(); // Close hamburger menu
    }

    function downloadAllReceiptsCSV() {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      
      if (receipts.length === 0) {
        alert('No receipts to download.');
        return;
      }
      
      let csvContent = "Token,Date,Item,Quantity,Price,Subtotal,Total\n";
      
      receipts.forEach(receipt => {
        const date = new Date(receipt.timestamp).toLocaleString();
        receipt.orders.forEach(order => {
          csvContent += `"${receipt.token}","${date}","${order.choice}","${order.quantity}","${order.price_each}","${order.total_price}","${receipt.total}"\n`;
        });
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'sweet-shop-receipts.csv';
      link.click();
      
      alert('All receipts downloaded as CSV file. You can open this in Excel or any spreadsheet program.');
      toggleMenu(); // Close hamburger menu
    }

    function deleteReceipt(index) {
      if (confirm('Are you sure you want to delete this receipt?')) {
        const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
        receipts.splice(index, 1);
        localStorage.setItem('sweetShopReceipts', JSON.stringify(receipts));
        showHistory(); // Refresh the history view
      }
    }

    function exportAllReceipts() {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      const dataStr = JSON.stringify(receipts, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = 'sweet-shop-receipts-backup.json';
      link.click();
      
      alert('Backup created! Save this file to your SSD or cloud storage for safekeeping.');
      toggleMenu(); // Close hamburger menu
    }

    function saveToGoogleDrive() {
      alert('To save to Google Drive:\n1. Download receipts using the "Download All as PDF" button\n2. Go to drive.google.com\n3. Upload the downloaded files to your Google Drive');
      toggleMenu(); // Close hamburger menu
    }

    function emailReceipts() {
      const receipts = JSON.parse(localStorage.getItem('sweetShopReceipts') || '[]');
      if (receipts.length === 0) {
        alert('No receipts to email.');
        return;
      }
      
      let emailBody = "Sweet Shop Receipts Summary:\n\n";
      receipts.forEach(receipt => {
        emailBody += `Token: ${receipt.token}, Date: ${new Date(receipt.timestamp).toLocaleString()}, Total: Rs. ${receipt.total}\n`;
      });
      
      const subject = encodeURIComponent("Sweet Shop Receipts Export");
      const body = encodeURIComponent(emailBody);
      window.open(`mailto:?subject=${subject}&body=${body}`);
      toggleMenu(); // Close hamburger menu
    }

    function printForPhysicalCopy() {
      alert('For physical copies:\n1. Use the "Print Receipt" button for individual receipts\n2. Use the "Download All as PDF" then print the PDF files\n3. Store the printed copies in a physical file or folder');
      toggleMenu(); // Close hamburger menu
    }

    function clearAllHistory() {
      if (confirm('Are you sure you want to delete ALL receipt history? This cannot be undone.')) {
        localStorage.removeItem('sweetShopReceipts');
        closeHistory();
      }
    }

    function newOrder() {
      // Reset form
      document.getElementById("icecream-choice").value = "";
      document.getElementById("sweet-choice").value = "";
      document.getElementById("icecream-qty").value = "";
      document.getElementById("sweet-qty").value = "";
      document.getElementById("total-display").innerText = "Total Amount: Rs. 0";
      
      // Hide elements
      document.getElementById("receipt-preview").style.display = "none";
      document.getElementById("print-btn").style.display = "none";
      document.getElementById("save-btn").style.display = "none";
      document.getElementById("print-instructions").style.display = "none";
      
      // Set focus with a delay to avoid autofocus error
      setTimeout(() => {
        document.getElementById("icecream-qty").focus();
      }, 100);
      
      currentTokenData = null;
    }

    // Auto-focus on quantity field when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Set focus with a delay to avoid autofocus error
      setTimeout(() => {
        document.getElementById("icecream-qty").focus();
      }, 500);
      
      // Close modal if clicked outside
      window.onclick = function(event) {
        const modal = document.getElementById('history-modal');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        
        if (event.target === modal) {
          closeHistory();
        }
        
        // Close hamburger menu when clicking outside
        if (!hamburgerMenu.contains(event.target) && hamburgerMenu.classList.contains('active')) {
          toggleMenu();
        }
      }
    });
  </script>
</body>
</html>
