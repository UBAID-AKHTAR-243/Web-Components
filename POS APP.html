<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales System/Bill Printer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* ===== Sales System Styles ===== */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      margin: 0;
      padding: 0;
      color: #e6e6e6;
    }
    
    .container {
      max-width: 1000px;
      width: 200%;
      margin: 0 auto;
      background: #16213e;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      border-radius: 8px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #0f3460;
      background: #0f3460;
      padding: 15px;
      border-radius: 8px;
      position: relative;
    }
    
    .header h1 {
      color: #ffffff;
      margin: 0;
      font-size: 24px;
    }
    
    .header p {
      margin: 5px 0;
      color: #b8b8b8;
      font-size: 14px;
    }
    
    .input-section {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      border: 1px solid #0f3460;
    }
    
    .input-section input {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 1px solid #0f3460;
      border-radius: 4px;
      font-size: 14px;
      background: #16213e;
      color: #e6e6e6;
    }
    
    .input-section button {
      background: #0f3460;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    
    .input-section button:hover {
      background: #1a5a9e;
    }
    
    .sales-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #0f3460;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .sales-table th {
      background-color: #0f3460;
      color: #ffffff;
      padding: 10px 8px;
      border: 1px solid #1a5a9e;
      text-align: center;
      font-weight: bold;
    }
    
    .sales-table td {
      padding: 10px 8px;
      border: 1px solid #1a5a9e;
      text-align: center;
      background: #1a1a2e;
    }
    
    .product-cell {
      text-align: left;
    }
    
    .quantity-controls {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    
    .quantity-controls button {
      background: #0f3460;
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 3px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .quantity-controls button:hover {
      background: #1a5a9e;
    }
    
    .quantity-controls input {
      width: 40px;
      text-align: center;
      border: 1px solid #0f3460;
      border-radius: 3px;
      background: #16213e;
      color: #e6e6e6;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    
    .action-buttons button {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }
    
    .return-btn {
      background: #ff9800;
      color: white;
    }
    
    .return-btn:hover {
      background: #e68900;
    }
    
    .exchange-btn {
      background: #2196F3;
      color: white;
    }
    
    .exchange-btn:hover {
      background: #0b7dda;
    }
    
    .price-inquiry-btn {
      background: #9c27b0;
      color: white;
    }
    
    .more-delivery-btn {
      background: #607d8b;
      color: white;
    }
    
    .totals-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #0f3460;
    }
    
    .totals-left {
      width: 50%;
    }
    
    .totals-right {
      width: 40%;
      text-align: right;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #0f3460;
    }
    
    .total-row:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 16px;
      color: #ffffff;
    }
    
    .keypad-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .keypad-btn {
      padding: 15px;
      font-size: 18px;
      background: #0f3460;
      border: 1px solid #1a5a9e;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      color: #ffffff;
      transition: background 0.3s;
    }
    
    .keypad-btn:hover {
      background: #1a5a9e;
    }
    
    .keypad-btn.zero {
      grid-column: span 2;
    }
    
    .footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px solid #0f3460;
      text-align: center;
      font-size: 12px;
      color: #b8b8b8;
    }
    
    .footer p {
      margin: 5px 0;
    }
    
    /* Control buttons */
    .control-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .control-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      transition: background 0.3s;
    }
    
    .print-btn {
      background: #0f3460;
    }
    
    .print-btn:hover {
      background: #1a5a9e;
    }
    
    .save-btn {
      background: #0f3460;
    }
    
    .save-btn:hover {
      background: #1a5a9e;
    }
    
    .history-btn {
      background: #0f3460;
    }
    
    .history-btn:hover {
      background: #1a5a9e;
    }
    
    .new-order-btn {
      background: #0f3460;
    }
    
    .new-order-btn:hover {
      background: #1a5a9e;
    }
    
    /* Barcode scanner */
    .barcode-section {
      background: #1a1a2e;
      border: 1px solid #0f3460;
      border-radius: 5px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .barcode-section h3 {
      margin-top: 0;
      color: #ffffff;
    }
    
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    
    #barcode-scanner {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .scanner-frame {
      width: 70%;
      height: 30%;
      border: 3px solid #0f3460;
      border-radius: 10px;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
      background-color: #16213e;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #0f3460;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      color: #e6e6e6;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #0f3460;
      padding-bottom: 10px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: bold;
      color: #ffffff;
    }
    
    .close-btn {
      color: #aaa;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-btn:hover {
      color: #ffffff;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .modal-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .modal-confirm {
      background: #0f3460;
      color: white;
    }
    
    .modal-cancel {
      background: #6c757d;
      color: white;
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
      .sales-table {
        font-size: 12px;
      }
      
      .sales-table th, 
      .sales-table td {
        padding: 6px 4px;
      }
      
      .totals-section {
        flex-direction: column;
      }
      
      .totals-left, .totals-right {
        width: 100%;
      }
      
      .keypad-section {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* Print styles */
    @media print {
      body * {
        visibility: hidden;
      }
      
      .container, .container * {
        visibility: visible;
      }
      
      .container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        box-shadow: none;
      }
      
      .input-section, .barcode-section, .control-buttons {
        display: none;
      }
    }

    /* Hamburger Menu */
    .hamburger-menu {
      position: absolute;
      top: 25px;
      right: 15px;
      z-index: 1000;
    }
    
    .hamburger-icon {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 30px;
      height: 21px;
      cursor: pointer;
    }
    
    .hamburger-icon span {
      height: 3px;
      width: 100%;
      background-color: #ffffff;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .hamburger-menu.active .hamburger-icon span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .hamburger-menu.active .hamburger-icon span:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger-menu.active .hamburger-icon span:nth-child(3) {
      transform: rotate(-45deg) translate(7px, -6px);
    }
    
    .menu-content {
      position: absolute;
      top: 40px;
      right: 0;
      background: #1a1a2e;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      width: 240px;
      padding: 15px;
      display: none;
      text-align: right;
      border: 1px solid #0f3460;
      z-index: 1001;
    }
    
    .hamburger-menu.active .menu-content {
      display: block;
    }
    
    .menu-section {
      margin-bottom: 20px;
    }
    
    .menu-section h3 {
      color: #ffffff;
      margin-top: 0;
      font-size: 16px;
      border-bottom: 1px solid #0f3460;
      padding-bottom: 8px;
    }
    
    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .menu-buttons button {
      min-width: auto;
      width: 100%;
      font-size: 14px;
      padding: 10px;
      background: #0f3460;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      text-align: left;
    }
    
    .menu-buttons button:hover {
      background: #1a5a9e;
    }

    /* Logo styles */
    .circle-container {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 40px;
      height: 40px;
      overflow: visible;
      z-index: 1000;
    }

    .circle {
      font-weight: 800;
      color: red;
      text-align: center;
      font-size: 8px;
      background-color: white;
      width: 100%;
      height: 100%;
      border: 3px solid #3498db;
      border-radius: 50%;
      position: relative;
      animation: rotateBorder 5s linear infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }

    .ball {
      position: absolute;
      width: 4px;
      height: 4px;
      background-color: #e74c3c;
      border-radius: 50%;
      top: 0;
      left: 50%;
      margin-top: -2px;
      margin-left: -2px;
      animation: rotateBall 5s linear infinite;
    }

    @keyframes rotateBorder {
      to { transform: rotate(360deg); }
    }

    @keyframes rotateBall {
      to { transform: rotate(360deg); }
    }

    /* Storage status indicator */
    .storage-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #0f3460;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .storage-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4CAF50;
    }

    .storage-indicator.offline {
      background: #f44336;
    }

    .storage-indicator.syncing {
      background: #FFC107;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Form styles for modals */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #0f3460;
      border-radius: 4px;
      background: #1a1a2e;
      color: #e6e6e6;
      box-sizing: border-box;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #1a5a9e;
    }

    .form-help {
      font-size: 12px;
      color: #b8b8b8;
      margin-top: 5px;
    }

    /* Folder selection styles */
    .folder-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .folder-path {
      flex: 1;
      padding: 10px;
      background: #1a1a2e;
      border: 1px solid #0f3460;
      border-radius: 4px;
      color: #b8b8b8;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Status messages */
    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }

    .status-success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
      color: #4CAF50;
    }

    .status-error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }

    .status-warning {
      background: rgba(255, 193, 7, 0.2);
      border: 1px solid #FFC107;
      color: #FFC107;
    }

    /* Format selection styles */
    .format-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .format-option {
      flex: 1;
      padding: 15px;
      text-align: center;
      background: #1a1a2e;
      border: 2px solid #0f3460;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .format-option:hover {
      background: #0f3460;
    }

    .format-option.selected {
      background: #1a5a9e;
      border-color: #2196F3;
    }

    .format-option i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }

    /* Backup settings */
    .backup-settings {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #0f3460;
      margin-top: 15px;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #0f3460;
    }

    .setting-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #0f3460;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #2196F3;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* Backup schedule */
    .schedule-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .schedule-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #1a1a2e;
      border-radius: 4px;
      border: 1px solid #0f3460;
    }

    .schedule-option.selected {
      background: #0f3460;
      border-color: #1a5a9e;
    }

    .schedule-option input[type="radio"] {
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <!-- Logo -->
      <div class="circle-container">
        <div class="circle">
          ÿßŸÑÿ¨ÿØ€åÿØ
          <br> ÿ®€å⁄©ÿ±ÿ≤
          <div class="ball"></div>
        </div>
      </div>
      
      <!-- Hamburger Menu -->
      <div class="hamburger-menu" id="hamburger-menu">
        <div class="hamburger-icon" onclick="toggleMenu()">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="menu-content">
          <div class="storage-status">
            <div class="storage-indicator" id="storage-indicator"></div>
            <span id="storage-status-text">Local Storage</span>
          </div>
          
          <div class="menu-section">
            <h3>üìã History</h3>
            <div class="menu-buttons">
              <button class="history-btn" onclick="showHistory()">üìã View History</button>
              <button class="history-btn" onclick="clearHistory()">üóëÔ∏è Clear History</button>
              <button class="history-btn" onclick="openBackupModal()">üíæ Backup Data</button>
            </div>
          </div>
          <div class="menu-section">
            <h3>‚öôÔ∏è Storage Settings</h3>
            <div class="menu-buttons">
              <button onclick="openCloudConfig()">‚òÅÔ∏è Configure Cloud Storage</button>
              <button onclick="openFolderSelector()">üìÅ Select Storage Folder</button>
              <button onclick="toggleStorageMode()" id="storage-toggle-btn">üíæ Switch to Cloud</button>
            </div>
          </div>
          <div class="menu-section">
            <h3>‚öôÔ∏è App Settings</h3>
            <div class="menu-buttons">
              <button onclick="openDiscountModal()">üí∞ Set Discount</button>
              <button onclick="openTaxModal()">üèõÔ∏è Set Tax</button>
            </div>
          </div>
        </div>
      </div>
      
      <h1>Aljadeed Sweets & Bakers </h1>
      <p>Enter ITEM CODE or Scan Product</p>
    </div>
    
    <!-- Input Section -->
    <div class="input-section">
      <input type="text" id="item-code" placeholder="Enter item code">
      <button onclick="addItem()">Add Item</button>
      <button onclick="toggleScanner()" id="scanner-toggle-btn">Scan Product</button>
      <button onclick="stopScanner()" id="scanner-stop-btn" style="display: none;">Stop Scanner</button>
    </div>
    
    <!-- Barcode Scanner Section -->
    <div class="barcode-section" id="barcode-section" style="display: none;">
      <h3>Barcode Scanner</h3>
      <div id="scanner-container">
        <div id="barcode-scanner"></div>
        <div class="scanner-overlay">
          <div class="scanner-frame"></div>
        </div>
      </div>
    </div>
    
    <!-- Sales Table -->
    <table class="sales-table">
      <thead>
        <tr>
          <th>Product Name/Price</th>
          <th>Unit Price</th>
          <th>Qty</th>
          <th>Discounts</th>
          <th>Total</th>
          <th>RETURN</th>
          <th>EXCHANGE</th>
        </tr>
      </thead>
      <tbody id="sales-table-body">
        <!-- Product rows will be added here dynamically -->
      </tbody>
    </table>
    
    <!-- Totals Section -->
    <div class="totals-section">
      <div class="totals-left">
        <div class="total-row">
          <span>SUB TOTAL:</span>
          <span id="subtotal-value">Rs 0.00</span>
        </div>
        <div class="total-row">
          <span>DISCOUNT:</span>
          <span id="discount-value">Rs 0.00</span>
        </div>
        <div class="total-row">
          <span>TAX:</span>
          <span id="tax-value">Rs 0.00</span>
        </div>
      </div>
      <div class="totals-right">
        <div class="total-row">
          <span>TOTAL AMOUNT</span>
          <span id="total-amount-value">Rs 0.00</span>
        </div>
      </div>
    </div>
    
    <!-- Keypad Section -->
    <div class="keypad-section">
      <div class="keypad-btn">7</div>
      <div class="keypad-btn">8</div>
      <div class="keypad-btn">9</div>
      <div class="keypad-btn">4</div>
      <div class="keypad-btn">5</div>
      <div class="keypad-btn">6</div>
      <div class="keypad-btn">1</div>
      <div class="keypad-btn">2</div>
      <div class="keypad-btn">3</div>
      <div class="keypad-btn zero">0</div>
      <div class="keypad-btn">00</div>
    </div>
    
    <!-- Control Buttons -->
    <div class="control-buttons">
      <button class="control-btn print-btn" onclick="printReceipt()">Print Receipt</button>
      <button class="control-btn save-btn" onclick="saveReceipt()">Save Receipt</button>
      <button class="control-btn new-order-btn" onclick="newOrder()">New Order</button>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <p>Ubaid Megasoft company Private Limited.</p>
    </div>
  </div>

  <!-- Return Modal -->
  <div id="return-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Return Item</div>
        <span class="close-btn" onclick="closeModal('return-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to return this item?</p>
        <div id="return-item-details"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-cancel" onclick="closeModal('return-modal')">Cancel</button>
        <button class="modal-btn modal-confirm" onclick="confirmReturn()">Confirm Return</button>
      </div>
    </div>
  </div>

  <!-- Exchange Modal -->
  <div id="exchange-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Exchange Item</div>
        <span class="close-btn" onclick="closeModal('exchange-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Select a new product to exchange with:</p>
        <div id="exchange-item-details"></div>
        <div class="input-section" style="margin-top: 15px;">
          <input type="text" id="exchange-item-code" placeholder="Enter new item code">
          <button onclick="addExchangeItem()">Add Item</button>
        </div>
        <div id="exchange-new-item"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-cancel" onclick="closeModal('exchange-modal')">Cancel</button>
        <button class="modal-btn modal-confirm" onclick="confirmExchange()">Confirm Exchange</button>
      </div>
    </div>
  </div>

  <!-- Discount Modal -->
  <div id="discount-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Set Global Discount</div>
        <span class="close-btn" onclick="closeModal('discount-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Set a global discount percentage that will be applied to all items:</p>
        <input type="number" id="discount-percentage" min="0" max="100" value="0" style="width: 100%; padding: 10px; background: #1a1a2e; color: #e6e6e6; border: 1px solid #0f3460; border-radius: 4px;">
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-cancel" onclick="closeModal('discount-modal')">Cancel</button>
        <button class="modal-btn modal-confirm" onclick="setGlobalDiscount()">Set Discount</button>
      </div>
    </div>
  </div>

  <!-- Tax Modal -->
  <div id="tax-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Set Tax Rate</div>
        <span class="close-btn" onclick="closeModal('tax-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Set the tax rate percentage:</p>
        <input type="number" id="tax-rate" min="0" max="100" value="5" style="width: 100%; padding: 10px; background: #1a1a2e; color: #e6e6e6; border: 1px solid #0f3460; border-radius: 4px;">
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-cancel" onclick="closeModal('tax-modal')">Cancel</button>
        <button class="modal-btn modal-confirm" onclick="setTaxRate()">Set Tax Rate</button>
      </div>
    </div>
  </div>

  <!-- Cloud Configuration Modal -->
  <div id="cloud-config-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Cloud Storage Configuration</div>
        <span class="close-btn" onclick="closeModal('cloud-config-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="cloud-provider">Cloud Provider</label>
          <select id="cloud-provider" onchange="toggleCustomEndpoint()">
            <option value="firebase">Firebase</option>
            <option value="supabase">Supabase</option>
            <option value="custom">Custom API</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="api-key">API Key</label>
          <input type="password" id="api-key" placeholder="Enter your API key">
        </div>
        
        <div class="form-group" id="custom-endpoint-group" style="display: none;">
          <label for="endpoint-url">Endpoint URL</label>
          <input type="text" id="endpoint-url" placeholder="https://api.example.com/data">
          <div class="form-help">Enter the full URL where your data should be sent</div>
        </div>
        
        <div class="form-group">
          <label for="project-id">Project ID / Database Name</label>
          <input type="text" id="project-id" placeholder="my-sales-app">
        </div>
        
        <div id="cloud-status"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-cancel" onclick="closeModal('cloud-config-modal')">Cancel</button>
        <button class="modal-btn modal-confirm" onclick="testCloudConnection()">Test Connection</button>
        <button class="modal-btn modal-confirm" onclick="saveCloudConfig()">Save Configuration</button>
      </div>
    </div>
  </div>

  <!-- Folder Selector Modal -->
  <div id="folder-selector-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Select Storage Folder</div>
        <span class="close-btn" onclick="closeModal('folder-selector-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <p>Choose a folder where your sales data will be stored:</p>
        
        <div class="folder-selector">
          <div class="folder-path" id="current-folder-path">No folder selected</div>
          <button class="modal-btn modal-confirm" onclick="selectFolder()">Browse</button>
        </div>
        
        <div class="form-help">
          This will create backup files in your selected folder. 
          <strong>Note:</strong> Folder access requires modern browser support.
        </div>
        
        <div id="folder-status"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-cancel" onclick="closeModal('folder-selector-modal')">Cancel</button>
        <button class="modal-btn modal-confirm" onclick="saveFolderSelection()">Save Folder</button>
      </div>
    </div>
  </div>

  <!-- Backup Modal -->
  <div id="backup-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Backup Data</div>
        <span class="close-btn" onclick="closeModal('backup-modal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Select Backup Format:</label>
          <div class="format-options">
            <div class="format-option" data-format="csv" onclick="selectFormat('csv')">
              <i>üìä</i>
              <div>CSV</div>
              <small>Spreadsheet format</small>
            </div>
            <div class="format-option" data-format="pdf" onclick="selectFormat('pdf')">
              <i>üìÑ</i>
              <div>PDF</div>
              <small>Printable format</small>
            </div>
            <div class="format-option" data-format="json" onclick="selectFormat('json')">
              <i>üîß</i>
              <div>JSON</div>
              <small>Data exchange</small>
            </div>
          </div>
        </div>

        <div class="backup-settings">
          <h4>Backup Settings</h4>
          
          <div class="setting-row">
            <div>
              <strong>Auto Backup</strong>
              <div class="form-help">Automatically backup data when changes occur</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="auto-backup-toggle" onchange="toggleAutoBackup()">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div id="auto-backup-settings" style="display: none;">
            <div class="schedule-options">
              <label class="schedule-option">
                <input type="radio" name="backup-schedule" value="immediate" checked onchange="updateBackupSchedule('immediate')">
                <div>
                  <strong>Immediate</strong>
                  <div class="form-help">Backup immediately when data changes</div>
                </div>
              </label>
              <label class="schedule-option">
                <input type="radio" name="backup-schedule" value="daily" onchange="updateBackupSchedule('daily')">
                <div>
                  <strong>Daily</strong>
                  <div class="form-help">Backup once per day at midnight</div>
                </div>
              </label>
              <label class="schedule-option">
                <input type="radio" name="backup-schedule" value="weekly" onchange="updateBackupSchedule('weekly')">
                <div>
                  <strong>Weekly</strong>
                  <div class="form-help">Backup every Sunday at midnight</div>
                </div>
              </label>
            </div>
          </div>

          <div class="setting-row">
            <div>
              <strong>Include Products</strong>
              <div class="form-help">Include product catalog in backup</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="include-products" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-row">
            <div>
              <strong>Compress Files</strong>
              <div class="form-help">Create smaller backup files</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="compress-files">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div id="backup-status"></div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-cancel" onclick="closeModal('backup-modal')">Cancel</button>
        <button class="modal-btn modal-confirm" onclick="createBackup()" id="create-backup-btn">Create Backup</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    let html5QrcodeScanner = null;
    let isScannerActive = false;
    let currentOrder = [];
    let receiptCounter = 5; // Starting receipt number
    let selectedRowIndex = -1;
    let exchangeItem = null;
    let globalDiscount = 0;
    let taxRate = 5;
    
    // Storage configuration
    let storageConfig = {
      mode: 'local', // 'local', 'cloud', 'file'
      cloud: {
        provider: 'firebase',
        apiKey: '',
        endpoint: '',
        projectId: '',
        connected: false
      },
      fileSystem: {
        folderHandle: null,
        folderPath: ''
      }
    };

    // Backup configuration
    let backupConfig = {
      format: 'csv', // 'csv', 'pdf', 'json'
      autoBackup: false,
      schedule: 'immediate', // 'immediate', 'daily', 'weekly'
      includeProducts: true,
      compressFiles: false,
      lastBackup: null
    };
    
    // Updated Product database with new items and prices
    const products = {
      '1001': { name: 'Barfi', price: 1000 },
      '1002': { name: 'Ras Gullay', price: 800 },
      '1003': { name: 'Gulab Jaman', price: 800 },
      '1004': { name: 'Pizza', price: 1500 },
      '1005': { name: 'Ice Cream', price: 150 },
      '1006': { name: 'Cold Drink', price: 60 }
    };
    
    // Initialize the app
    function initializeApp() {
      loadStorageConfig();
      loadBackupConfig();
      initializeTable();
      updateStorageUI();
      setupAutoBackup();
      
      // Add keypad functionality
      document.querySelectorAll('.keypad-btn').forEach(button => {
        button.addEventListener('click', function() {
          const itemCodeInput = document.getElementById('item-code');
          itemCodeInput.value += this.textContent;
        });
      });
      
      // Close menu when clicking outside
      window.addEventListener('click', function(event) {
        const hamburgerMenu = document.getElementById('hamburger-menu');
        if (!hamburgerMenu.contains(event.target)) {
          hamburgerMenu.classList.remove('active');
        }
      });
    }
    
    // Load storage configuration from localStorage
    function loadStorageConfig() {
      const savedConfig = localStorage.getItem('storageConfig');
      if (savedConfig) {
        storageConfig = JSON.parse(savedConfig);
      }
    }
    
    // Save storage configuration to localStorage
    function saveStorageConfig() {
      localStorage.setItem('storageConfig', JSON.stringify(storageConfig));
      updateStorageUI();
    }

    // Load backup configuration from localStorage
    function loadBackupConfig() {
      const savedConfig = localStorage.getItem('backupConfig');
      if (savedConfig) {
        backupConfig = JSON.parse(savedConfig);
        updateBackupUI();
      }
    }

    // Save backup configuration to localStorage
    function saveBackupConfig() {
      localStorage.setItem('backupConfig', JSON.stringify(backupConfig));
    }

    // Update backup UI elements
    function updateBackupUI() {
      // Update format selection
      document.querySelectorAll('.format-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.format === backupConfig.format) {
          option.classList.add('selected');
        }
      });

      // Update auto backup toggle
      document.getElementById('auto-backup-toggle').checked = backupConfig.autoBackup;
      document.getElementById('auto-backup-settings').style.display = 
        backupConfig.autoBackup ? 'block' : 'none';

      // Update schedule selection
      document.querySelector(`input[name="backup-schedule"][value="${backupConfig.schedule}"]`).checked = true;

      // Update other toggles
      document.getElementById('include-products').checked = backupConfig.includeProducts;
      document.getElementById('compress-files').checked = backupConfig.compressFiles;
    }
    
    // Update storage UI elements
    function updateStorageUI() {
      const indicator = document.getElementById('storage-indicator');
      const statusText = document.getElementById('storage-status-text');
      const toggleBtn = document.getElementById('storage-toggle-btn');
      
      // Update status indicator
      indicator.className = 'storage-indicator';
      if (storageConfig.mode === 'cloud') {
        if (storageConfig.cloud.connected) {
          indicator.classList.add('online');
          statusText.textContent = 'Cloud Storage (Connected)';
        } else {
          indicator.classList.add('offline');
          statusText.textContent = 'Cloud Storage (Not Connected)';
        }
      } else if (storageConfig.mode === 'file') {
        if (storageConfig.fileSystem.folderHandle) {
          indicator.classList.add('online');
          statusText.textContent = 'File Storage (Configured)';
        } else {
          indicator.classList.add('offline');
          statusText.textContent = 'File Storage (Not Configured)';
        }
      } else {
        indicator.classList.add('online');
        statusText.textContent = 'Local Storage';
      }
      
      // Update toggle button text
      if (storageConfig.mode === 'local') {
        toggleBtn.textContent = 'üíæ Switch to Cloud';
      } else if (storageConfig.mode === 'cloud') {
        toggleBtn.textContent = 'üì± Switch to Local';
      } else {
        toggleBtn.textContent = 'üì± Switch to Local';
      }
    }
    
    // Toggle storage mode
    function toggleStorageMode() {
      if (storageConfig.mode === 'local') {
        if (!storageConfig.cloud.apiKey) {
          alert('Please configure cloud storage first');
          openCloudConfig();
          return;
        }
        storageConfig.mode = 'cloud';
      } else if (storageConfig.mode === 'cloud') {
        storageConfig.mode = 'local';
      } else {
        storageConfig.mode = 'local';
      }
      
      saveStorageConfig();
      alert(`Storage mode switched to ${storageConfig.mode}`);
    }
    
    // Initialize the table
    function initializeTable() {
      const tableBody = document.getElementById('sales-table-body');
      
      // Sample data with updated products
      const sampleData = [
        { code: '1001', name: 'Barfi', price: 1000.00, qty: 2, discount: 50.00, total: 1950.00 },
        { code: '1002', name: 'Ras Gullay', price: 800.00, qty: 1, discount: 20.00, total: 780.00 },
        { code: '1004', name: 'Pizza', price: 1500.00, qty: 1, discount: 75.00, total: 1425.00 }
      ];
      
      sampleData.forEach(item => {
        addProductToTable(item);
        currentOrder.push(item);
      });
      
      updateTotals();
    }
    
    // Add product to table
    function addProductToTable(product) {
      const tableBody = document.getElementById('sales-table-body');
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="product-cell">${product.name} (${product.code})</td>
        <td>Rs ${product.price.toFixed(2)}</td>
        <td>
          <div class="quantity-controls">
            <button onclick="decreaseQuantity(this)">-</button>
            <input type="text" value="${product.qty}" onchange="updateQuantity(this)">
            <button onclick="increaseQuantity(this)">+</button>
          </div>
        </td>
        <td>Rs ${product.discount.toFixed(2)}</td>
        <td>Rs ${product.total.toFixed(2)}</td>
        <td>
          <div class="action-buttons">
            <button class="return-btn" onclick="openReturnModal(${currentOrder.length})">RETURN</button>
          </div>
        </td>
        <td>
          <div class="action-buttons">
            <button class="exchange-btn" onclick="openExchangeModal(${currentOrder.length})">EXCHANGE</button>
          </div>
        </td>
      `;
      
      tableBody.appendChild(row);
    }
    
    // Add item by code
    function addItem() {
      const itemCode = document.getElementById('item-code').value.trim();
      
      if (!itemCode) {
        alert('Please enter an item code');
        return;
      }
      
      if (products[itemCode]) {
        const product = products[itemCode];
        const newItem = {
          code: itemCode,
          name: product.name,
          price: product.price,
          qty: 1,
          discount: 0,
          total: product.price
        };
        
        addProductToTable(newItem);
        currentOrder.push(newItem);
        updateTotals();

        // Trigger auto backup if enabled
        if (backupConfig.autoBackup && backupConfig.schedule === 'immediate') {
          setTimeout(() => createAutoBackup(), 1000);
        }
        
        // Clear input
        document.getElementById('item-code').value = '';
      } else {
        alert('Product not found. Available codes: 1001 (Barfi), 1002 (Ras Gullay), 1003 (Gulab Jaman), 1004 (Pizza)');
      }
    }
    
    // Update totals
    function updateTotals() {
      let subtotal = 0;
      let totalDiscount = 0;
      
      currentOrder.forEach(item => {
        subtotal += item.price * item.qty;
        totalDiscount += item.discount;
      });
      
      // Apply global discount
      const globalDiscountAmount = (globalDiscount / 100) * subtotal;
      totalDiscount += globalDiscountAmount;
      
      const tax = (taxRate / 100) * (subtotal - totalDiscount);
      const totalAmount = subtotal - totalDiscount + tax;
      
      document.getElementById('subtotal-value').textContent = `Rs ${subtotal.toFixed(2)}`;
      document.getElementById('discount-value').textContent = `Rs ${totalDiscount.toFixed(2)}`;
      document.getElementById('tax-value').textContent = `Rs ${tax.toFixed(2)}`;
      document.getElementById('total-amount-value').textContent = `Rs ${totalAmount.toFixed(2)}`;
    }
    
    // Quantity controls
    function increaseQuantity(button) {
      const input = button.parentElement.querySelector('input');
      input.value = parseInt(input.value) + 1;
      updateQuantity(input);
    }
    
    function decreaseQuantity(button) {
      const input = button.parentElement.querySelector('input');
      if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
        updateQuantity(input);
      }
    }
    
    function updateQuantity(input) {
      const row = input.closest('tr');
      const rowIndex = Array.from(row.parentElement.children).indexOf(row);
      
      if (currentOrder[rowIndex]) {
        currentOrder[rowIndex].qty = parseInt(input.value);
        currentOrder[rowIndex].total = (currentOrder[rowIndex].price * currentOrder[rowIndex].qty) - currentOrder[rowIndex].discount;
        
        // Update total in table
        const totalCell = row.querySelector('td:nth-child(5)');
        totalCell.textContent = `Rs ${currentOrder[rowIndex].total.toFixed(2)}`;
        
        updateTotals();
      }
    }
    
    // Return Functions
    function openReturnModal(rowIndex) {
      selectedRowIndex = rowIndex;
      const item = currentOrder[rowIndex];
      
      document.getElementById('return-item-details').innerHTML = `
        <p><strong>Product:</strong> ${item.name}</p>
        <p><strong>Price:</strong> Rs ${item.price.toFixed(2)}</p>
        <p><strong>Quantity:</strong> ${item.qty}</p>
        <p><strong>Total:</strong> Rs ${item.total.toFixed(2)}</p>
      `;
      
      document.getElementById('return-modal').style.display = 'block';
    }
    
    function confirmReturn() {
      if (selectedRowIndex >= 0) {
        // Remove the item from the table
        const tableBody = document.getElementById('sales-table-body');
        tableBody.deleteRow(selectedRowIndex);
        
        // Remove the item from currentOrder
        currentOrder.splice(selectedRowIndex, 1);
        
        // Update totals
        updateTotals();
        
        // Close modal
        closeModal('return-modal');
        selectedRowIndex = -1;
        
        alert('Item returned successfully!');
      }
    }
    
    // Exchange Functions
    function openExchangeModal(rowIndex) {
      selectedRowIndex = rowIndex;
      const item = currentOrder[rowIndex];
      
      document.getElementById('exchange-item-details').innerHTML = `
        <p><strong>Current Product:</strong> ${item.name}</p>
        <p><strong>Price:</strong> Rs ${item.price.toFixed(2)}</p>
        <p><strong>Quantity:</strong> ${item.qty}</p>
        <p><strong>Total:</strong> Rs ${item.total.toFixed(2)}</p>
      `;
      
      document.getElementById('exchange-new-item').innerHTML = '';
      exchangeItem = null;
      
      document.getElementById('exchange-modal').style.display = 'block';
    }
    
    function addExchangeItem() {
      const itemCode = document.getElementById('exchange-item-code').value.trim();
      
      if (!itemCode) {
        alert('Please enter an item code');
        return;
      }
      
      if (products[itemCode]) {
        const product = products[itemCode];
        exchangeItem = {
          code: itemCode,
          name: product.name,
          price: product.price,
          qty: 1,
          discount: 0,
          total: product.price
        };
        
        document.getElementById('exchange-new-item').innerHTML = `
          <p><strong>New Product:</strong> ${product.name}</p>
          <p><strong>Price:</strong> Rs ${product.price.toFixed(2)}</p>
        `;
        
        // Clear input
        document.getElementById('exchange-item-code').value = '';
      } else {
        alert('Product not found. Available codes: 1001 (Barfi), 1002 (Ras Gullay), 1003 (Gulab Jaman), 1004 (Pizza)');
      }
    }
    
    function confirmExchange() {
      if (selectedRowIndex >= 0 && exchangeItem) {
        // Replace the item in the table
        const tableBody = document.getElementById('sales-table-body');
        const row = tableBody.rows[selectedRowIndex];
        
        row.cells[0].innerHTML = `${exchangeItem.name} (${exchangeItem.code})`;
        row.cells[1].innerHTML = `Rs ${exchangeItem.price.toFixed(2)}`;
        row.cells[2].innerHTML = `
          <div class="quantity-controls">
            <button onclick="decreaseQuantity(this)">-</button>
            <input type="text" value="${exchangeItem.qty}" onchange="updateQuantity(this)">
            <button onclick="increaseQuantity(this)">+</button>
          </div>
        `;
        row.cells[3].innerHTML = `Rs ${exchangeItem.discount.toFixed(2)}`;
        row.cells[4].innerHTML = `Rs ${exchangeItem.total.toFixed(2)}`;
        
        // Replace the item in currentOrder
        currentOrder[selectedRowIndex] = exchangeItem;
        
        // Update totals
        updateTotals();
        
        // Close modal
        closeModal('exchange-modal');
        selectedRowIndex = -1;
        exchangeItem = null;
        
        alert('Item exchanged successfully!');
      } else {
        alert('Please select a new product to exchange with');
      }
    }
    
    // Modal Functions
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      selectedRowIndex = -1;
      exchangeItem = null;
    }
    
    // Barcode scanner functions
    function toggleScanner() {
      if (isScannerActive) {
        stopScanner();
        return;
      }
      
      const barcodeSection = document.getElementById('barcode-section');
      const scannerToggleBtn = document.getElementById('scanner-toggle-btn');
      const scannerStopBtn = document.getElementById('scanner-stop-btn');
      
      barcodeSection.style.display = 'block';
      scannerToggleBtn.style.display = 'none';
      scannerStopBtn.style.display = 'inline-block';
      
      // Initialize the barcode scanner
      html5QrcodeScanner = new Html5Qrcode("barcode-scanner");
      
      const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 150 },
        supportedScanTypes: [
          Html5QrcodeScanType.SCAN_TYPE_CAMERA
        ],
        formatsToSupport: [
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.CODE_128
        ]
      };
      
      html5QrcodeScanner.start(
        { facingMode: "environment" }, 
        config,
        onScanSuccess,
        onScanFailure
      ).then(() => {
        isScannerActive = true;
      }).catch(err => {
        console.error("Scanner start failed:", err);
        alert("Failed to start scanner. Please check camera permissions.");
        stopScanner();
      });
    }
    
    function stopScanner() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => {
          isScannerActive = false;
          document.getElementById('barcode-section').style.display = 'none';
          document.getElementById('scanner-toggle-btn').style.display = 'inline-block';
          document.getElementById('scanner-stop-btn').style.display = 'none';
          html5QrcodeScanner.clear();
        }).catch(err => {
          console.error("Scanner stop failed:", err);
        });
      }
    }
    
    function onScanSuccess(decodedText, decodedResult) {
      // Process the barcode
      if (products[decodedText]) {
        const product = products[decodedText];
        const newItem = {
          code: decodedText,
          name: product.name,
          price: product.price,
          qty: 1,
          discount: 0,
          total: product.price
        };
        
        addProductToTable(newItem);
        currentOrder.push(newItem);
        updateTotals();
        
        // Show success message
        alert(`Added ${product.name} to your order!`);
      } else {
        alert(`Product with barcode ${decodedText} not found in our database. Available codes: 1001 (Barfi), 1002 (Ras Gullay), 1003 (Gulab Jaman), 1004 (Pizza)`);
      }
    }
    
    function onScanFailure(error) {
      // Expected to be called often, no need to handle every failure
    }
    
    // Print receipt
    function printReceipt() {
      window.print();
    }
    
    // Save receipt
    function saveReceipt() {
      const receiptData = {
        order: currentOrder,
        subtotal: parseFloat(document.getElementById('subtotal-value').textContent.replace('Rs ', '')),
        discount: parseFloat(document.getElementById('discount-value').textContent.replace('Rs ', '')),
        tax: parseFloat(document.getElementById('tax-value').textContent.replace('Rs ', '')),
        total: parseFloat(document.getElementById('total-amount-value').textContent.replace('Rs ', '')),
        receiptNo: receiptCounter,
        timestamp: new Date().toISOString()
      };
      
      // Save based on storage mode
      if (storageConfig.mode === 'local') {
        saveToLocalStorage(receiptData);
      } else if (storageConfig.mode === 'cloud') {
        saveToCloudStorage(receiptData);
      } else if (storageConfig.mode === 'file') {
        saveToFileSystem(receiptData);
      }
      
      receiptCounter++;
    }
    
    // Save to local storage
    function saveToLocalStorage(receiptData) {
      let receipts = JSON.parse(localStorage.getItem('salesReceipts') || '[]');
      receipts.push(receiptData);
      localStorage.setItem('salesReceipts', JSON.stringify(receipts));
      alert('Receipt saved to local storage!');
    }
    
    // Save to cloud storage
    async function saveToCloudStorage(receiptData) {
      if (!storageConfig.cloud.apiKey) {
        alert('Cloud storage not configured. Please set up cloud storage first.');
        openCloudConfig();
        return;
      }
      
      try {
        // Show syncing status
        const indicator = document.getElementById('storage-indicator');
        indicator.classList.add('syncing');
        
        // Simulate API call (replace with actual cloud API)
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Save to local storage as backup
        saveToLocalStorage(receiptData);
        
        // In a real implementation, you would send data to your cloud service here
        console.log('Saving to cloud:', receiptData);
        
        alert('Receipt saved to cloud storage!');
      } catch (error) {
        console.error('Cloud save failed:', error);
        alert('Failed to save to cloud. Receipt saved locally instead.');
        
        // Fallback to local storage
        saveToLocalStorage(receiptData);
      } finally {
        // Reset indicator
        updateStorageUI();
      }
    }
    
    // Save to file system
    async function saveToFileSystem(receiptData) {
      if (!storageConfig.fileSystem.folderHandle) {
        alert('File storage not configured. Please select a folder first.');
        openFolderSelector();
        return;
      }
      
      try {
        // Get existing receipts
        let receipts = JSON.parse(localStorage.getItem('salesReceipts') || '[]');
        receipts.push(receiptData);
        
        // Save to local storage
        localStorage.setItem('salesReceipts', JSON.stringify(receipts));
        
        // Save to file system
        const filename = `sales_backup_${new Date().toISOString().split('T')[0]}.json`;
        const fileHandle = await storageConfig.fileSystem.folderHandle.getFileHandle(filename, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(receipts, null, 2));
        await writable.close();
        
        alert(`Receipt saved! Backup created: ${filename}`);
      } catch (error) {
        console.error('File system save failed:', error);
        alert('Failed to save to file system. Receipt saved locally only.');
      }
    }
    
    // Show history
    function showHistory() {
      const receipts = JSON.parse(localStorage.getItem('salesReceipts') || '[]');
      
      if (receipts.length === 0) {
        alert('No receipts found in history.');
      } else {
        let historyText = 'Receipt History:\n\n';
        
        receipts.forEach((receipt, index) => {
          historyText += `Receipt #${receipt.receiptNo} - Rs ${receipt.total.toFixed(2)} - ${new Date(receipt.timestamp).toLocaleString()}\n`;
        });
        
        alert(historyText);
      }
    }
    
    // New order
    function newOrder() {
      if (confirm('Are you sure you want to start a new order? Current order will be cleared.')) {
        document.getElementById('sales-table-body').innerHTML = '';
        currentOrder = [];
        updateTotals();
      }
    }
    
    // Hamburger menu toggle
    function toggleMenu() {
      document.getElementById('hamburger-menu').classList.toggle('active');
    }
    
    // NEW BACKUP FEATURES
    
    // Open backup modal
    function openBackupModal() {
      updateBackupUI();
      document.getElementById('backup-modal').style.display = 'block';
    }

    // Select backup format
    function selectFormat(format) {
      backupConfig.format = format;
      updateBackupUI();
    }

    // Toggle auto backup
    function toggleAutoBackup() {
      backupConfig.autoBackup = document.getElementById('auto-backup-toggle').checked;
      document.getElementById('auto-backup-settings').style.display = 
        backupConfig.autoBackup ? 'block' : 'none';
      saveBackupConfig();

      if (backupConfig.autoBackup) {
        setupAutoBackup();
        showStatus('backup-status', 'Auto backup enabled', 'success');
      } else {
        showStatus('backup-status', 'Auto backup disabled', 'warning');
      }
    }

    // Update backup schedule
    function updateBackupSchedule(schedule) {
      backupConfig.schedule = schedule;
      saveBackupConfig();
      setupAutoBackup();
    }

    // Setup auto backup based on schedule
    function setupAutoBackup() {
      // Clear any existing intervals
      if (window.autoBackupInterval) {
        clearInterval(window.autoBackupInterval);
      }

      if (!backupConfig.autoBackup) return;

      switch (backupConfig.schedule) {
        case 'immediate':
          // Already handled in addItem and saveReceipt functions
          break;
        case 'daily':
          // Set up daily backup at midnight
          const now = new Date();
          const midnight = new Date(now);
          midnight.setHours(24, 0, 0, 0);
          const timeUntilMidnight = midnight - now;

          setTimeout(() => {
            createAutoBackup();
            // Set up recurring daily backup
            window.autoBackupInterval = setInterval(() => {
              createAutoBackup();
            }, 24 * 60 * 60 * 1000); // 24 hours
          }, timeUntilMidnight);
          break;
        case 'weekly':
          // Set up weekly backup on Sunday at midnight
          const today = new Date();
          const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
          const daysUntilSunday = dayOfWeek === 0 ? 7 : 7 - dayOfWeek;
          const nextSunday = new Date(today);
          nextSunday.setDate(today.getDate() + daysUntilSunday);
          nextSunday.setHours(0, 0, 0, 0);

          const timeUntilSunday = nextSunday - today;

          setTimeout(() => {
            createAutoBackup();
            // Set up recurring weekly backup
            window.autoBackupInterval = setInterval(() => {
              createAutoBackup();
            }, 7 * 24 * 60 * 60 * 1000); // 7 days
          }, timeUntilSunday);
          break;
      }
    }

    // Create auto backup (called automatically)
    function createAutoBackup() {
      const receipts = JSON.parse(localStorage.getItem('salesReceipts') || '[]');
      
      if (receipts.length === 0) {
        return; // No data to backup
      }

      try {
        backupConfig.lastBackup = new Date().toISOString();
        saveBackupConfig();

        // Create backup based on selected format
        switch (backupConfig.format) {
          case 'csv':
            createCSVBackup(receipts, true);
            break;
          case 'pdf':
            createPDFBackup(receipts, true);
            break;
          case 'json':
            createJSONBackup(receipts, true);
            break;
        }

        console.log('Auto backup completed successfully');
      } catch (error) {
        console.error('Auto backup failed:', error);
      }
    }

    // Create manual backup
    function createBackup() {
      const receipts = JSON.parse(localStorage.getItem('salesReceipts') || '[]');
      const includeProducts = document.getElementById('include-products').checked;
      backupConfig.includeProducts = includeProducts;
      backupConfig.compressFiles = document.getElementById('compress-files').checked;
      
      saveBackupConfig();

      if (receipts.length === 0) {
        showStatus('backup-status', 'No data to backup', 'warning');
        return;
      }

      try {
        // Show creating status
        showStatus('backup-status', 'Creating backup...', 'warning');
        document.getElementById('create-backup-btn').disabled = true;

        setTimeout(() => {
          // Create backup based on selected format
          switch (backupConfig.format) {
            case 'csv':
              createCSVBackup(receipts);
              break;
            case 'pdf':
              createPDFBackup(receipts);
              break;
            case 'json':
              createJSONBackup(receipts);
              break;
          }

          backupConfig.lastBackup = new Date().toISOString();
          saveBackupConfig();
          
          showStatus('backup-status', 'Backup created successfully!', 'success');
          document.getElementById('create-backup-btn').disabled = false;
        }, 1000);

      } catch (error) {
        console.error('Backup failed:', error);
        showStatus('backup-status', 'Backup failed: ' + error.message, 'error');
        document.getElementById('create-backup-btn').disabled = false;
      }
    }

    // Create CSV backup
    function createCSVBackup(receipts, isAuto = false) {
      let csvContent = "Receipt No,Date,Time,Subtotal,Discount,Tax,Total,Items\n";
      
      receipts.forEach(receipt => {
        const date = new Date(receipt.timestamp);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString();
        
        // Format items as a string
        const itemsStr = receipt.order.map(item => 
          `${item.name} (Qty: ${item.qty}, Price: Rs ${item.price.toFixed(2)})`
        ).join('; ');
        
        csvContent += `"${receipt.receiptNo}","${dateStr}","${timeStr}","Rs ${receipt.subtotal.toFixed(2)}","Rs ${receipt.discount.toFixed(2)}","Rs ${receipt.tax.toFixed(2)}","Rs ${receipt.total.toFixed(2)}","${itemsStr}"\n`;
      });

      // Add products if enabled
      if (backupConfig.includeProducts) {
        csvContent += "\n\nProducts\nCode,Name,Price\n";
        Object.keys(products).forEach(code => {
          const product = products[code];
          csvContent += `"${code}","${product.name}","Rs ${product.price.toFixed(2)}"\n`;
        });
      }
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sales_backup_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      if (!isAuto) {
        alert('CSV backup created successfully!');
      }
    }

    // Create PDF backup
    function createPDFBackup(receipts, isAuto = false) {
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(16);
      doc.text('Sales Data Backup', 20, 20);
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
      
      // Add receipts
      let y = 50;
      doc.setFontSize(12);
      doc.text('Receipts:', 20, y);
      y += 10;
      
      receipts.forEach((receipt, index) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        
        doc.setFontSize(10);
        doc.text(`Receipt #${receipt.receiptNo} - ${new Date(receipt.timestamp).toLocaleString()}`, 20, y);
        y += 6;
        doc.text(`Subtotal: Rs ${receipt.subtotal.toFixed(2)} | Discount: Rs ${receipt.discount.toFixed(2)}`, 20, y);
        y += 6;
        doc.text(`Tax: Rs ${receipt.tax.toFixed(2)} | Total: Rs ${receipt.total.toFixed(2)}`, 20, y);
        y += 6;
        doc.text('Items:', 20, y);
        y += 6;
        
        receipt.order.forEach(item => {
          if (y > 270) {
            doc.addPage();
            y = 20;
          }
          doc.text(`  - ${item.name} (Qty: ${item.qty}, Price: Rs ${item.price.toFixed(2)})`, 25, y);
          y += 5;
        });
        
        y += 10;
      });

      // Add products if enabled
      if (backupConfig.includeProducts) {
        if (y > 250) {
          doc.addPage();
          y = 20;
        }
        
        doc.setFontSize(12);
        doc.text('Products:', 20, y);
        y += 10;
        
        Object.keys(products).forEach(code => {
          if (y > 270) {
            doc.addPage();
            y = 20;
          }
          const product = products[code];
          doc.text(`  - ${product.name} (Code: ${code}, Price: Rs ${product.price.toFixed(2)})`, 25, y);
          y += 6;
        });
      }
      
      doc.save(`sales_backup_${new Date().toISOString().split('T')[0]}.pdf`);
      
      if (!isAuto) {
        alert('PDF backup created successfully!');
      }
    }

    // Create JSON backup
    function createJSONBackup(receipts, isAuto = false) {
      const backupData = {
        receipts,
        backupDate: new Date().toISOString(),
        totalReceipts: receipts.length,
        totalSales: receipts.reduce((sum, r) => sum + r.total, 0)
      };

      // Add products if enabled
      if (backupConfig.includeProducts) {
        backupData.products = products;
      }
      
      const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sales_backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      if (!isAuto) {
        alert('JSON backup created successfully!');
      }
    }
    
    // Cloud configuration
    function openCloudConfig() {
      // Load current config
      document.getElementById('cloud-provider').value = storageConfig.cloud.provider;
      document.getElementById('api-key').value = storageConfig.cloud.apiKey;
      document.getElementById('endpoint-url').value = storageConfig.cloud.endpoint;
      document.getElementById('project-id').value = storageConfig.cloud.projectId;
      
      toggleCustomEndpoint();
      document.getElementById('cloud-config-modal').style.display = 'block';
    }
    
    function toggleCustomEndpoint() {
      const provider = document.getElementById('cloud-provider').value;
      const customEndpointGroup = document.getElementById('custom-endpoint-group');
      
      if (provider === 'custom') {
        customEndpointGroup.style.display = 'block';
      } else {
        customEndpointGroup.style.display = 'none';
      }
    }
    
    function testCloudConnection() {
      const apiKey = document.getElementById('api-key').value;
      const provider = document.getElementById('cloud-provider').value;
      const endpoint = document.getElementById('endpoint-url').value;
      const projectId = document.getElementById('project-id').value;
      
      if (!apiKey) {
        showStatus('cloud-status', 'Please enter an API key', 'error');
        return;
      }
      
      // Show testing status
      showStatus('cloud-status', 'Testing connection...', 'warning');
      
      // Simulate connection test (replace with actual API test)
      setTimeout(() => {
        // In a real app, you would make an actual API call here
        showStatus('cloud-status', 'Connection successful!', 'success');
      }, 1500);
    }
    
    function saveCloudConfig() {
      storageConfig.cloud.provider = document.getElementById('cloud-provider').value;
      storageConfig.cloud.apiKey = document.getElementById('api-key').value;
      storageConfig.cloud.endpoint = document.getElementById('endpoint-url').value;
      storageConfig.cloud.projectId = document.getElementById('project-id').value;
      storageConfig.cloud.connected = true;
      
      saveStorageConfig();
      closeModal('cloud-config-modal');
      alert('Cloud storage configuration saved!');
    }
    
    // Folder selection
    function openFolderSelector() {
      document.getElementById('current-folder-path').textContent = 
        storageConfig.fileSystem.folderPath || 'No folder selected';
      document.getElementById('folder-selector-modal').style.display = 'block';
    }
    
    async function selectFolder() {
      try {
        // Check if the File System Access API is supported
        if (!('showDirectoryPicker' in window)) {
          showStatus('folder-status', 
            'File System Access API not supported in this browser. Try Chrome or Edge.', 
            'error');
          return;
        }
        
        // Request folder access
        const folderHandle = await window.showDirectoryPicker();
        const folderPath = folderHandle.name;
        
        // Store the folder handle
        storageConfig.fileSystem.folderHandle = folderHandle;
        storageConfig.fileSystem.folderPath = folderPath;
        
        // Update UI
        document.getElementById('current-folder-path').textContent = folderPath;
        showStatus('folder-status', 'Folder selected successfully!', 'success');
        
      } catch (error) {
        console.error('Folder selection failed:', error);
        if (error.name !== 'AbortError') {
          showStatus('folder-status', 'Failed to select folder: ' + error.message, 'error');
        }
      }
    }
    
    function saveFolderSelection() {
      if (!storageConfig.fileSystem.folderHandle) {
        showStatus('folder-status', 'Please select a folder first', 'error');
        return;
      }
      
      storageConfig.mode = 'file';
      saveStorageConfig();
      closeModal('folder-selector-modal');
      alert('File storage configured successfully!');
    }
    
    // Set discount modal
    function openDiscountModal() {
      document.getElementById('discount-percentage').value = globalDiscount;
      document.getElementById('discount-modal').style.display = 'block';
    }
    
    function setGlobalDiscount() {
      globalDiscount = parseFloat(document.getElementById('discount-percentage').value);
      if (isNaN(globalDiscount) || globalDiscount < 0 || globalDiscount > 100) {
        alert('Please enter a valid discount percentage between 0 and 100');
        return;
      }
      
      updateTotals();
      closeModal('discount-modal');
      alert(`Global discount set to ${globalDiscount}%`);
    }
    
    // Set tax modal
    function openTaxModal() {
      document.getElementById('tax-rate').value = taxRate;
      document.getElementById('tax-modal').style.display = 'block';
    }
    
    function setTaxRate() {
      taxRate = parseFloat(document.getElementById('tax-rate').value);
      if (isNaN(taxRate) || taxRate < 0 || taxRate > 100) {
        alert('Please enter a valid tax rate between 0 and 100');
        return;
      }
      
      updateTotals();
      closeModal('tax-modal');
      alert(`Tax rate set to ${taxRate}%`);
    }
    
    // Clear history
    function clearHistory() {
      if (confirm('Are you sure you want to clear all history? This action cannot be undone.')) {
        localStorage.removeItem('salesReceipts');
        alert('History cleared successfully!');
      }
    }
    
    // Utility function to show status messages
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
    }
    
    // Initialize the app when page loads
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
